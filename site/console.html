<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="assets/console.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-image">
    <link rel="icon" href="favicon.icon" type="image/x-image">
    <title>Suntabu</title>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <script>
        var commandIndex = -1;
        var hash = null;

        function scrollBottom() {
            $('#output').scrollTop($('#output')[0].scrollHeight);
        }

        function setcookie(name, value, expires, path, domain, secure) {
            var curcookie = name + "=" + encodeURI(value)
                + ((expires) ? ";expires=" + expires.toGMTString() : "")
                + ((path) ? ";path=" + path : "")
                + ((domain) ? ";domain=" + domain : "")
                + ((secure) ? ";secure" : "");
            document.cookie = curcookie;
        }

        function getSpecificCookie(name) {
            if (document.cookie.length > 0) {
                start = document.cookie.indexOf(name + "=");
                if (start != -1) {
                    start = start + name.length + 1;
                    end = document.cookie.indexOf(";", start);
                    if (end == -1) {
                        end = document.cookie.length;
                    }
                }
                return decodeURI(document.cookie.substring(start, end));
            }
            return "";
        }

        function runCommand(command) {
            scrollBottom();
            var url = "console/run?command=" + encodeURI(encodeURIComponent(command));

            $.post(url, {c: getSpecificCookie("c")}, function (data, status, request) {
                if (command.startsWith("login")) {
                    var now = new Date();
                    now.setDate(now.getDate() + 0.5);
                    setcookie("c", data, now);
                }

                var disp = request.getResponseHeader('Content-Disposition');
                if (disp && disp.search('attachment') != -1) {
                    window.open(data);
                    return;
                }


                updateConsole(function () {
                    updateCommand(commandIndex - 1);
                });
            });
            resetInput();
        }


        function updateConsole(callback) {
            $.post("console/out", {c: getSpecificCookie("c")}, function (data, status) {
                // Check if we are scrolled to the bottom to force scrolling on update
                var output = $('#output');
                shouldScroll = (output[0].scrollHeight - output.scrollTop()) == output.innerHeight();
                output.val(String(data));
                if (callback) callback();
                if (shouldScroll) scrollBottom();
            });
        }

        function resetInput() {
            commandIndex = -1;
            $("#input").val("");
        }

        function previousCommand() {
            updateCommand(commandIndex + 1);
        }

        function nextCommand() {
            updateCommand(commandIndex - 1);
        }

        function updateCommand(index) {
            // Check if we are at the defualt index and clear the input
            if (index < 0) {
                resetInput();
                return;
            }

            $.get("console/commandHistory?index=" + index, function (data, status) {
                if (data) {
                    commandIndex = index;
                    $("#input").val(String(data));
                }
            });
        }

        function complete(command) {
            $.get("console/complete?command=" + command, function (data, status) {
                if (data) {
                    $("#input").val(String(data));
                }
            });
        }

        // Poll to update the console output
        window.setInterval(function () {
            updateConsole(null)
        }, 500);
    </script>
</head>

<body class="console">
<textarea id="output" class="console" readOnly></textarea>
<textarea id="input" class="console" autofocus rows="1"></textarea>
<form action="" method="post" enctype="multipart/form-data" name="form1" id="form1"></form>
<table width="100%" cellpadding="0" cellspacing="0" class="upload">
    <tbody>
    <tr>
        <td width="320px" style="padding-left:10px;">
            <input name="button" type="file" id="file" multiple="">
        </td>

        <td>
            <input type="submit" name="button" id="button" value="Upload" style="height:26px">
        </td>
    </tr>
    </tbody>
</table>
<script>
    $("#input").keydown(function (e) {
        if (e.keyCode == 13) { // Enter
            // we don't want a line break in the console
            e.preventDefault();
            runCommand($("#input").val());
        } else if (e.keyCode == 38) { // Up
            previousCommand();
        } else if (e.keyCode == 40) { // Down
            nextCommand();
        } else if (e.keyCode == 27) { // Escape
            resetInput();
        } else if (e.keyCode == 9) { // Tab
            e.preventDefault();
            complete($("#input").val());
        }
    });
</script>
</body>

</html>
